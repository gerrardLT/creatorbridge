generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  name          String?
  email         String?   @unique
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  ipAssets         IPAsset[]
  transactions     Transaction[]
  licenseTemplates LicenseTemplate[]
}

model LicenseTemplate {
  id                 String   @id @default(cuid())
  userId             String
  name               String
  licenseType        String
  mintingFee         String?
  commercialRevShare Int?
  customTerms        String?  // JSON stored as string for SQLite
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  user               User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, name])
}

model IPAsset {
  id            String    @id @default(cuid())
  ipId          String?   @unique
  tokenId       String?
  title         String
  description   String
  imageUrl      String
  priceEth      Float
  txHash        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // License fields
  licenseType       String?   // NON_COMMERCIAL | COMMERCIAL_USE | COMMERCIAL_REMIX
  mintingFee        String?   // Fee in WIP/ETH as string
  commercialRevShare Int?     // 0-100 percentage
  licenseTermsId    String?   // Story Protocol license terms ID
  spgNftContract    String?   // SPG NFT collection address
  
  creatorId     String
  creator       User      @relation(fields: [creatorId], references: [id])
  licenses      License[]
  
  // Derivative relations
  parentRelations DerivativeRelation[] @relation("ChildIP")
  childRelations  DerivativeRelation[] @relation("ParentIP")
}

model DerivativeRelation {
  id             String   @id @default(cuid())
  parentIpId     String
  childIpId      String
  licenseTokenId String?
  txHash         String?
  registeredAt   DateTime @default(now())
  
  parentIp       IPAsset  @relation("ParentIP", fields: [parentIpId], references: [id])
  childIp        IPAsset  @relation("ChildIP", fields: [childIpId], references: [id])
  
  @@unique([parentIpId, childIpId])
}

model License {
  id            String    @id @default(cuid())
  licenseId     String?   @unique
  txHash        String?
  purchasedAt   DateTime  @default(now())
  
  ipAssetId     String
  ipAsset       IPAsset   @relation(fields: [ipAssetId], references: [id])
  buyerId       String
}

model Transaction {
  id            String    @id @default(cuid())
  type          String
  amount        Float
  txHash        String
  createdAt     DateTime  @default(now())
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  assetId       String?
  assetTitle    String
}
