generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  name          String?
  email         String?   @unique
  avatarUrl     String?
  bio           String?   // User biography
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  ipAssets         IPAsset[]
  transactions     Transaction[]
  licenseTemplates LicenseTemplate[]
  
  // Follow relationships
  following        Follow[]   @relation("Following")
  followers        Follow[]   @relation("Followers")
  
  // Favorites
  favorites        Favorite[]
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  ipAssetId String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAsset   IPAsset  @relation(fields: [ipAssetId], references: [id], onDelete: Cascade)
  
  @@unique([userId, ipAssetId])
}

model LicenseTemplate {
  id                 String   @id @default(cuid())
  userId             String
  name               String
  licenseType        String
  mintingFee         String?
  commercialRevShare Int?
  customTerms        String?  // JSON stored as string for SQLite
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  user               User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, name])
}

model Tag {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  color       String   @default("#6366f1") // Hex color
  icon        String?  // Emoji or icon name
  createdAt   DateTime @default(now())
  
  ipAssets    IPAssetTag[]
}

model IPAssetTag {
  id        String   @id @default(cuid())
  ipAssetId String
  tagId     String
  createdAt DateTime @default(now())
  
  ipAsset   IPAsset  @relation(fields: [ipAssetId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([ipAssetId, tagId])
}

model IPAsset {
  id            String    @id @default(cuid())
  ipId          String?   @unique
  tokenId       String?
  title         String
  description   String
  imageUrl      String
  priceEth      Float
  txHash        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // License fields
  licenseType       String?   // NON_COMMERCIAL | COMMERCIAL_USE | COMMERCIAL_REMIX
  mintingFee        String?   // Fee in WIP/ETH as string
  commercialRevShare Int?     // 0-100 percentage
  licenseTermsId    String?   // Story Protocol license terms ID
  spgNftContract    String?   // SPG NFT collection address
  
  creatorId     String
  creator       User      @relation(fields: [creatorId], references: [id])
  licenses      License[]
  tags          IPAssetTag[]
  favorites     Favorite[]
  
  // Derivative relations
  parentRelations DerivativeRelation[] @relation("ChildIP")
  childRelations  DerivativeRelation[] @relation("ParentIP")
}

model DerivativeRelation {
  id             String   @id @default(cuid())
  parentIpId     String
  childIpId      String
  licenseTokenId String?
  txHash         String?
  registeredAt   DateTime @default(now())
  
  parentIp       IPAsset  @relation("ParentIP", fields: [parentIpId], references: [id])
  childIp        IPAsset  @relation("ChildIP", fields: [childIpId], references: [id])
  
  @@unique([parentIpId, childIpId])
}

model License {
  id            String    @id @default(cuid())
  licenseId     String?   @unique
  txHash        String?
  purchasedAt   DateTime  @default(now())
  
  ipAssetId     String
  ipAsset       IPAsset   @relation(fields: [ipAssetId], references: [id])
  buyerId       String
}

model Transaction {
  id            String    @id @default(cuid())
  type          String
  amount        Float
  txHash        String
  createdAt     DateTime  @default(now())
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  assetId       String?
  assetTitle    String
}

